#!/usr/bin/env node
var Web3 = require("web3")
var sleep = require("sleep").sleep

var RPC_HOST = process.env.ETH_RPC_HOST || "localhost"
var RPC_PORT = process.env.ETH_RPC_PORT || 8545
var RPC_URL = `http://${RPC_HOST}:${RPC_PORT}`

var web3 = new Web3(new Web3.providers.HttpProvider(RPC_URL))

sleep(3)
var genesis
while (!genesis) {
  try {
    genesis = web3.eth.getBlock(0)
  } catch (error) {
    console.error(`keeper: error: could not connect to ${RPC_URL}`)
    console.error(`keeper: error: ${error.message}`)
    sleep(1)
  }
}

console.log(`Connected to Ethereum RPC endpoint at ${RPC_URL}.`)
console.log(`Available accounts: ${JSON.stringify(web3.eth.accounts)}`)

for (var account of web3.eth.accounts) {
  console.log(`Balance (${account}): ${web3.eth.getBalance(account)}`)
}

web3.eth.filter("latest", (error, log) => {
  console.log(log)
})
